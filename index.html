<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>微信图片查看器</title>

    <!-- 1. 引入 Fluent UI Web Components -->
    <script type="module" src="https://npm.elemecdn.com/@fluentui/web-components"></script>

    <!-- 2. 链接到外部样式表 -->
    <link rel="stylesheet" href="style.css">
    <style>
        /* Modal for full-size image */
        #image-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            overflow: auto;
            padding: 20px;
        }

        #image-modal .modal-content {
            background: transparent;
            border-radius: 6px;
            max-width: none;
            max-height: none;
            box-shadow: none;
        }

        #image-modal canvas {
            display: block;
            image-rendering: auto;
            max-width: none;
            max-height: none;
        }

        #image-modal .modal-caption {
            color: #fff;
            margin-top: 8px;
            text-align: center;
            word-break: break-all;
        }

        #image-modal .close-btn {
            position: fixed;
            top: 12px;
            right: 16px;
            background: rgba(0,0,0,0.5);
            color: #fff;
            border: none;
            padding: 8px 10px;
            cursor: pointer;
            font-size: 14px;
            border-radius: 4px;
            z-index: 10000;
        }
        /* toolbar inside modal */
        #image-modal .modal-toolbar {
            position: fixed;
            top: 12px;
            left: 16px;
            display: flex;
            gap: 8px;
            z-index: 10000;
        }
        #image-modal .modal-toolbar button {
            background: rgba(0,0,0,0.5);
            color: #fff;
            border: none;
            padding: 6px 8px;
            cursor: pointer;
            border-radius: 4px;
        }
    </style>
</head>

<body>
    <fluent-design-system-provider>
        <div class="app-container">
            <!-- 左侧导航栏 -->
            <nav class="nav-bar">
                <fluent-button id="home-btn" appearance="transparent" title="主页">
                    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 32 32" fill="none">
                        <path
                            d="M6.09192 4.42812C6.09192 4.23482 6.24862 4.07812 6.44192 4.07812H9.79061C9.98391 4.07812 10.1406 4.23483 10.1406 4.42812V14.7308H6.09192V4.42812Z"
                            fill="url(#paint0_radial_18_6002)" />
                        <path
                            d="M6.09192 4.42812C6.09192 4.23482 6.24862 4.07812 6.44192 4.07812H9.79061C9.98391 4.07812 10.1406 4.23483 10.1406 4.42812V14.7308H6.09192V4.42812Z"
                            fill="url(#paint1_linear_18_6002)" />
                        <path
                            d="M6.09192 4.42812C6.09192 4.23482 6.24862 4.07812 6.44192 4.07812H9.79061C9.98391 4.07812 10.1406 4.23483 10.1406 4.42812V14.7308H6.09192V4.42812Z"
                            fill="url(#paint2_linear_18_6002)" />
                        <path
                            d="M6.09192 4.42812C6.09192 4.23482 6.24862 4.07812 6.44192 4.07812H9.79061C9.98391 4.07812 10.1406 4.23483 10.1406 4.42812V14.7308H6.09192V4.42812Z"
                            fill="url(#paint3_linear_18_6002)" />
                        <path
                            d="M6.09192 4.42812C6.09192 4.23482 6.24862 4.07812 6.44192 4.07812H9.79061C9.98391 4.07812 10.1406 4.23483 10.1406 4.42812V14.7308H6.09192V4.42812Z"
                            fill="url(#paint4_radial_18_6002)" />
                        <path d="M27.6563 29.1593H4.64062V15.7182L16.1485 4.96533L27.6563 15.7182V29.1593Z"
                            fill="url(#paint5_linear_18_6002)" />
                        <path d="M27.6563 29.1593H4.64062V15.7182L16.1485 4.96533L27.6563 15.7182V29.1593Z"
                            fill="url(#paint6_linear_18_6002)" />
                        <path d="M27.6563 29.1593H4.64062V15.7182L16.1485 4.96533L27.6563 15.7182V29.1593Z"
                            fill="url(#paint7_radial_18_6002)" />
                        <path d="M27.6563 29.1593H4.64062V15.7182L16.1485 4.96533L27.6563 15.7182V29.1593Z"
                            fill="url(#paint8_linear_18_6002)" />
                        <path d="M27.6563 29.1593H4.64062V15.7182L16.1485 4.96533L27.6563 15.7182V29.1593Z"
                            fill="url(#paint9_radial_18_6002)" />
                        <path d="M27.6563 29.1593H4.64062V15.7182L16.1485 4.96533L27.6563 15.7182V29.1593Z"
                            fill="url(#paint10_linear_18_6002)" />
                        <path d="M27.6563 29.1593H4.64062V15.7182L16.1485 4.96533L27.6563 15.7182V29.1593Z"
                            fill="url(#paint11_linear_18_6002)" />
                        <g filter="url(#filter0_f_18_6002)">
                            <path
                                d="M15.0662 29.1592H8.12341V18.1523C8.12341 17.3136 8.65569 16.6248 9.30368 16.6248H13.8859C14.5339 16.6248 15.0662 17.3136 15.0662 18.1523V29.1592V29.1592Z"
                                fill="url(#paint12_linear_18_6002)" />
                        </g>
                        <g filter="url(#filter1_i_18_6002)">
                            <path
                                d="M23.6493 21.8641H19.461C18.9907 21.8641 18.6233 21.4819 18.6233 21.0263V16.8377C18.6233 16.3674 19.0054 16 19.461 16H23.6493C24.1195 16 24.4869 16.3821 24.4869 16.8377V21.0263C24.4869 21.4966 24.1195 21.8641 23.6493 21.8641Z"
                                fill="url(#paint13_linear_18_6002)" />
                            <path
                                d="M23.6493 21.8641H19.461C18.9907 21.8641 18.6233 21.4819 18.6233 21.0263V16.8377C18.6233 16.3674 19.0054 16 19.461 16H23.6493C24.1195 16 24.4869 16.3821 24.4869 16.8377V21.0263C24.4869 21.4966 24.1195 21.8641 23.6493 21.8641Z"
                                fill="url(#paint14_linear_18_6002)" />
                        </g>
                        <path
                            d="M23.6493 21.8641H19.461C18.9907 21.8641 18.6233 21.4819 18.6233 21.0263V16.8377C18.6233 16.3674 19.0054 16 19.461 16H23.6493C24.1195 16 24.4869 16.3821 24.4869 16.8377V21.0263C24.4869 21.4966 24.1195 21.8641 23.6493 21.8641Z"
                            fill="url(#paint15_linear_18_6002)" />
                        <path
                            d="M23.6493 21.8641H19.461C18.9907 21.8641 18.6233 21.4819 18.6233 21.0263V16.8377C18.6233 16.3674 19.0054 16 19.461 16H23.6493C24.1195 16 24.4869 16.3821 24.4869 16.8377V21.0263C24.4869 21.4966 24.1195 21.8641 23.6493 21.8641Z"
                            fill="url(#paint16_linear_18_6002)" />
                        <g filter="url(#filter2_ii_18_6002)">
                            <path
                                d="M16.2568 27.8979H8.51355V17.4636C8.51355 16.6687 9.1072 16.0156 9.82991 16.0156H14.9405C15.6632 16.0156 16.2568 16.6687 16.2568 17.4636V27.8979V27.8979Z"
                                fill="url(#paint17_linear_18_6002)" />
                        </g>
                        <g filter="url(#filter3_f_18_6002)">
                            <path
                                d="M14.3173 22.2729C14.6252 22.2729 14.8748 22.0233 14.8748 21.7154C14.8748 21.4075 14.6252 21.158 14.3173 21.158C14.0095 21.158 13.7599 21.4075 13.7599 21.7154C13.7599 22.0233 14.0095 22.2729 14.3173 22.2729Z"
                                fill="#62393D" />
                        </g>
                        <g filter="url(#filter4_ii_18_6002)">
                            <path
                                d="M14.462 22.1888C14.773 22.1888 15.0251 21.9367 15.0251 21.6257C15.0251 21.3146 14.773 21.0625 14.462 21.0625C14.1509 21.0625 13.8988 21.3146 13.8988 21.6257C13.8988 21.9367 14.1509 22.1888 14.462 22.1888Z"
                                fill="#895D56" />
                        </g>
                        <path
                            d="M29.7382 15.8467L16.9977 3.29507C16.5253 2.8227 15.756 2.8227 15.2836 3.29507C15.2836 3.29507 15.2701 3.29507 15.2701 3.30857L2.50259 15.8737C2.03022 16.346 2.03022 17.1018 2.50259 17.5607C2.97497 18.0196 3.74426 18.0331 4.21663 17.5607L15.9584 5.99176C16.0558 5.89587 16.212 5.89587 16.3093 5.99176L28.0107 17.5202C28.483 17.9926 29.2523 17.9926 29.7247 17.5202C30.1971 17.0478 30.2106 16.3055 29.7382 15.8467Z"
                            fill="url(#paint18_linear_18_6002)" />
                        <path
                            d="M29.7382 15.8467L16.9977 3.29507C16.5253 2.8227 15.756 2.8227 15.2836 3.29507C15.2836 3.29507 15.2701 3.29507 15.2701 3.30857L2.50259 15.8737C2.03022 16.346 2.03022 17.1018 2.50259 17.5607C2.97497 18.0196 3.74426 18.0331 4.21663 17.5607L15.9584 5.99176C16.0558 5.89587 16.212 5.89587 16.3093 5.99176L28.0107 17.5202C28.483 17.9926 29.2523 17.9926 29.7247 17.5202C30.1971 17.0478 30.2106 16.3055 29.7382 15.8467Z"
                            fill="url(#paint19_radial_18_6002)" />
                        <g filter="url(#filter5_f_18_6002)">
                            <path d="M7.3584 27.2782H16.0001V28.4103H7.3584V27.2782Z" fill="#68552B" />
                        </g>
                        <g filter="url(#filter6_i_18_6002)">
                            <path
                                d="M2.14832 29.9317C2.14832 28.8149 3.05364 27.9095 4.17042 27.9095H28.0637C29.1805 27.9095 30.0858 28.8149 30.0858 29.9317V29.9317H2.14832V29.9317Z"
                                fill="url(#paint20_linear_18_6002)" />
                        </g>
                        <path
                            d="M2.14832 29.9317C2.14832 28.8149 3.05364 27.9095 4.17042 27.9095H28.0637C29.1805 27.9095 30.0858 28.8149 30.0858 29.9317V29.9317H2.14832V29.9317Z"
                            fill="url(#paint21_linear_18_6002)" />
                        <path
                            d="M2.14832 29.9317C2.14832 28.8149 3.05364 27.9095 4.17042 27.9095H28.0637C29.1805 27.9095 30.0858 28.8149 30.0858 29.9317V29.9317H2.14832V29.9317Z"
                            fill="url(#paint22_radial_18_6002)" />
                        <path
                            d="M7.56262 27.7776C7.56262 27.3634 7.89841 27.0276 8.31262 27.0276H16.3257C16.8128 27.0276 17.2077 27.4225 17.2077 27.9096V27.9096H7.56262V27.7776Z"
                            fill="url(#paint23_linear_18_6002)" />
                        <path
                            d="M7.56262 27.7776C7.56262 27.3634 7.89841 27.0276 8.31262 27.0276H16.3257C16.8128 27.0276 17.2077 27.4225 17.2077 27.9096V27.9096H7.56262V27.7776Z"
                            fill="url(#paint24_linear_18_6002)" />
                        <path
                            d="M7.56262 27.7776C7.56262 27.3634 7.89841 27.0276 8.31262 27.0276H16.3257C16.8128 27.0276 17.2077 27.4225 17.2077 27.9096V27.9096H7.56262V27.7776Z"
                            fill="url(#paint25_linear_18_6002)" />
                        <g filter="url(#filter7_f_18_6002)">
                            <path d="M16.3385 3.89661L29.1147 16.4768" stroke="url(#paint26_linear_18_6002)"
                                stroke-width="0.3" stroke-linecap="round" />
                        </g>
                        <g filter="url(#filter8_f_18_6002)">
                            <path d="M16.3385 3.89661L3.56233 16.4768" stroke="url(#paint27_linear_18_6002)"
                                stroke-opacity="0.5" stroke-width="0.3" stroke-linecap="round" />
                        </g>
                        <defs>
                            <filter id="filter0_f_18_6002" x="7.62341" y="16.1248" width="7.94275" height="13.5344"
                                filterUnits="userSpaceOnUse" color-interpolation-filters="sRGB">
                                <feFlood flood-opacity="0" result="BackgroundImageFix" />
                                <feBlend mode="normal" in="SourceGraphic" in2="BackgroundImageFix" result="shape" />
                                <feGaussianBlur stdDeviation="0.25" result="effect1_foregroundBlur_18_6002" />
                            </filter>
                            <filter id="filter1_i_18_6002" x="18.1233" y="16" width="6.36365" height="6.36401"
                                filterUnits="userSpaceOnUse" color-interpolation-filters="sRGB">
                                <feFlood flood-opacity="0" result="BackgroundImageFix" />
                                <feBlend mode="normal" in="SourceGraphic" in2="BackgroundImageFix" result="shape" />
                                <feColorMatrix in="SourceAlpha" type="matrix"
                                    values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 127 0" result="hardAlpha" />
                                <feOffset dx="-0.5" dy="0.5" />
                                <feGaussianBlur stdDeviation="0.25" />
                                <feComposite in2="hardAlpha" operator="arithmetic" k2="-1" k3="1" />
                                <feColorMatrix type="matrix"
                                    values="0 0 0 0 0.0470588 0 0 0 0 0.47451 0 0 0 0 0.792157 0 0 0 1 0" />
                                <feBlend mode="normal" in2="shape" result="effect1_innerShadow_18_6002" />
                            </filter>
                            <filter id="filter2_ii_18_6002" x="8.31355" y="16.0156" width="8.19329" height="11.8823"
                                filterUnits="userSpaceOnUse" color-interpolation-filters="sRGB">
                                <feFlood flood-opacity="0" result="BackgroundImageFix" />
                                <feBlend mode="normal" in="SourceGraphic" in2="BackgroundImageFix" result="shape" />
                                <feColorMatrix in="SourceAlpha" type="matrix"
                                    values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 127 0" result="hardAlpha" />
                                <feOffset dx="0.25" />
                                <feGaussianBlur stdDeviation="0.25" />
                                <feComposite in2="hardAlpha" operator="arithmetic" k2="-1" k3="1" />
                                <feColorMatrix type="matrix"
                                    values="0 0 0 0 0.254902 0 0 0 0 0.188235 0 0 0 0 0.141176 0 0 0 1 0" />
                                <feBlend mode="normal" in2="shape" result="effect1_innerShadow_18_6002" />
                                <feColorMatrix in="SourceAlpha" type="matrix"
                                    values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 127 0" result="hardAlpha" />
                                <feOffset dx="-0.2" />
                                <feGaussianBlur stdDeviation="0.15" />
                                <feComposite in2="hardAlpha" operator="arithmetic" k2="-1" k3="1" />
                                <feColorMatrix type="matrix"
                                    values="0 0 0 0 0.694118 0 0 0 0 0.470588 0 0 0 0 0.407843 0 0 0 1 0" />
                                <feBlend mode="normal" in2="effect1_innerShadow_18_6002"
                                    result="effect2_innerShadow_18_6002" />
                            </filter>
                            <filter id="filter3_f_18_6002" x="13.6099" y="21.008" width="1.41487" height="1.41487"
                                filterUnits="userSpaceOnUse" color-interpolation-filters="sRGB">
                                <feFlood flood-opacity="0" result="BackgroundImageFix" />
                                <feBlend mode="normal" in="SourceGraphic" in2="BackgroundImageFix" result="shape" />
                                <feGaussianBlur stdDeviation="0.075" result="effect1_foregroundBlur_18_6002" />
                            </filter>
                            <filter id="filter4_ii_18_6002" x="13.7988" y="21.0625" width="1.32634" height="1.12634"
                                filterUnits="userSpaceOnUse" color-interpolation-filters="sRGB">
                                <feFlood flood-opacity="0" result="BackgroundImageFix" />
                                <feBlend mode="normal" in="SourceGraphic" in2="BackgroundImageFix" result="shape" />
                                <feColorMatrix in="SourceAlpha" type="matrix"
                                    values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 127 0" result="hardAlpha" />
                                <feOffset dx="-0.1" />
                                <feGaussianBlur stdDeviation="0.1" />
                                <feComposite in2="hardAlpha" operator="arithmetic" k2="-1" k3="1" />
                                <feColorMatrix type="matrix"
                                    values="0 0 0 0 0.694118 0 0 0 0 0.482353 0 0 0 0 0.419608 0 0 0 1 0" />
                                <feBlend mode="normal" in2="shape" result="effect1_innerShadow_18_6002" />
                                <feColorMatrix in="SourceAlpha" type="matrix"
                                    values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 127 0" result="hardAlpha" />
                                <feOffset dx="0.1" />
                                <feGaussianBlur stdDeviation="0.1" />
                                <feComposite in2="hardAlpha" operator="arithmetic" k2="-1" k3="1" />
                                <feColorMatrix type="matrix"
                                    values="0 0 0 0 0.290196 0 0 0 0 0.184314 0 0 0 0 0.164706 0 0 0 1 0" />
                                <feBlend mode="normal" in2="effect1_innerShadow_18_6002"
                                    result="effect2_innerShadow_18_6002" />
                            </filter>
                            <filter id="filter5_f_18_6002" x="6.8584" y="26.7782" width="9.6416" height="2.13208"
                                filterUnits="userSpaceOnUse" color-interpolation-filters="sRGB">
                                <feFlood flood-opacity="0" result="BackgroundImageFix" />
                                <feBlend mode="normal" in="SourceGraphic" in2="BackgroundImageFix" result="shape" />
                                <feGaussianBlur stdDeviation="0.25" result="effect1_foregroundBlur_18_6002" />
                            </filter>
                            <filter id="filter6_i_18_6002" x="2.14832" y="27.9095" width="28.4375" height="2.02209"
                                filterUnits="userSpaceOnUse" color-interpolation-filters="sRGB">
                                <feFlood flood-opacity="0" result="BackgroundImageFix" />
                                <feBlend mode="normal" in="SourceGraphic" in2="BackgroundImageFix" result="shape" />
                                <feColorMatrix in="SourceAlpha" type="matrix"
                                    values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 127 0" result="hardAlpha" />
                                <feOffset dx="0.5" />
                                <feGaussianBlur stdDeviation="0.5" />
                                <feComposite in2="hardAlpha" operator="arithmetic" k2="-1" k3="1" />
                                <feColorMatrix type="matrix"
                                    values="0 0 0 0 0.25098 0 0 0 0 0.545098 0 0 0 0 0.352941 0 0 0 1 0" />
                                <feBlend mode="normal" in2="shape" result="effect1_innerShadow_18_6002" />
                            </filter>
                            <filter id="filter7_f_18_6002" x="15.5885" y="3.14658" width="14.2762" height="14.0802"
                                filterUnits="userSpaceOnUse" color-interpolation-filters="sRGB">
                                <feFlood flood-opacity="0" result="BackgroundImageFix" />
                                <feBlend mode="normal" in="SourceGraphic" in2="BackgroundImageFix" result="shape" />
                                <feGaussianBlur stdDeviation="0.3" result="effect1_foregroundBlur_18_6002" />
                            </filter>
                            <filter id="filter8_f_18_6002" x="2.81235" y="3.14658" width="14.2762" height="14.0802"
                                filterUnits="userSpaceOnUse" color-interpolation-filters="sRGB">
                                <feFlood flood-opacity="0" result="BackgroundImageFix" />
                                <feBlend mode="normal" in="SourceGraphic" in2="BackgroundImageFix" result="shape" />
                                <feGaussianBlur stdDeviation="0.3" result="effect1_foregroundBlur_18_6002" />
                            </filter>
                            <radialGradient id="paint0_radial_18_6002" cx="0" cy="0" r="1"
                                gradientUnits="userSpaceOnUse"
                                gradientTransform="translate(9.59305 4.67442) rotate(90) scale(4.73002 2.5818)">
                                <stop stop-color="#F1B379" />
                                <stop offset="1" stop-color="#CD915F" />
                            </radialGradient>
                            <linearGradient id="paint1_linear_18_6002" x1="5.81228" y1="8.19254" x2="7.50578"
                                y2="8.19254" gradientUnits="userSpaceOnUse">
                                <stop stop-color="#8E694B" />
                                <stop offset="1" stop-color="#8E694B" stop-opacity="0" />
                            </linearGradient>
                            <linearGradient id="paint2_linear_18_6002" x1="9.62498" y1="10.5625" x2="8.36723"
                                y2="7.88223" gradientUnits="userSpaceOnUse">
                                <stop stop-color="#9F6A42" />
                                <stop offset="1" stop-color="#9F6A42" stop-opacity="0" />
                            </linearGradient>
                            <linearGradient id="paint3_linear_18_6002" x1="8.11626" y1="4.02028" x2="8.11626"
                                y2="4.19381" gradientUnits="userSpaceOnUse">
                                <stop stop-color="#D5AD80" />
                                <stop offset="1" stop-color="#D5AD80" stop-opacity="0" />
                            </linearGradient>
                            <radialGradient id="paint4_radial_18_6002" cx="0" cy="0" r="1"
                                gradientUnits="userSpaceOnUse"
                                gradientTransform="translate(10.6154 4.26905) rotate(-180) scale(2.80503 0.548434)">
                                <stop stop-color="#FFCB8C" />
                                <stop offset="1" stop-color="#FFCB8C" stop-opacity="0" />
                            </radialGradient>
                            <linearGradient id="paint5_linear_18_6002" x1="5.47765" y1="20.7771" x2="27.0212"
                                y2="20.7771" gradientUnits="userSpaceOnUse">
                                <stop stop-color="#D7905F" />
                                <stop offset="1" stop-color="#E8BC97" />
                            </linearGradient>
                            <linearGradient id="paint6_linear_18_6002" x1="6.08331" y1="29.7215" x2="13.7907"
                                y2="17.8555" gradientUnits="userSpaceOnUse">
                                <stop stop-color="#BA8951" />
                                <stop offset="1" stop-color="#BA8951" stop-opacity="0" />
                            </linearGradient>
                            <radialGradient id="paint7_radial_18_6002" cx="0" cy="0" r="1"
                                gradientUnits="userSpaceOnUse"
                                gradientTransform="translate(20.5636 28.3793) rotate(-118.804) scale(3.83795 4.81691)">
                                <stop stop-color="#BEAB75" />
                                <stop offset="1" stop-color="#BEAB75" stop-opacity="0" />
                            </radialGradient>
                            <linearGradient id="paint8_linear_18_6002" x1="27.6563" y1="24.0765" x2="26.9168"
                                y2="24.0765" gradientUnits="userSpaceOnUse">
                                <stop stop-color="#FFE6B1" />
                                <stop offset="1" stop-color="#FFE6B1" stop-opacity="0" />
                            </linearGradient>
                            <radialGradient id="paint9_radial_18_6002" cx="0" cy="0" r="1"
                                gradientUnits="userSpaceOnUse"
                                gradientTransform="translate(27.9282 14.916) rotate(90) scale(4.71709 1.06597)">
                                <stop offset="0.35" stop-color="#9E413E" />
                                <stop offset="1" stop-color="#9E413E" stop-opacity="0" />
                            </radialGradient>
                            <linearGradient id="paint10_linear_18_6002" x1="20.2259" y1="9.00546" x2="19.0774"
                                y2="10.1796" gradientUnits="userSpaceOnUse">
                                <stop stop-color="#B55852" />
                                <stop offset="1" stop-color="#B55852" stop-opacity="0" />
                            </linearGradient>
                            <linearGradient id="paint11_linear_18_6002" x1="4.49865" y1="26.3849" x2="5.28452"
                                y2="26.3849" gradientUnits="userSpaceOnUse">
                                <stop stop-color="#845F3D" />
                                <stop offset="1" stop-color="#845F3D" stop-opacity="0" />
                            </linearGradient>
                            <linearGradient id="paint12_linear_18_6002" x1="11.5948" y1="16.6248" x2="11.5948"
                                y2="29.1592" gradientUnits="userSpaceOnUse">
                                <stop stop-color="#805139" />
                                <stop offset="1" stop-color="#6D4D2F" />
                            </linearGradient>
                            <linearGradient id="paint13_linear_18_6002" x1="18.6233" y1="22.3078" x2="24.9507" y2="16"
                                gradientUnits="userSpaceOnUse">
                                <stop stop-color="#4CCCFF" />
                                <stop offset="1" stop-color="#3A9EE6" />
                            </linearGradient>
                            <linearGradient id="paint14_linear_18_6002" x1="21.5551" y1="22.232" x2="21.5551"
                                y2="21.0785" gradientUnits="userSpaceOnUse">
                                <stop stop-color="#1E9FE4" />
                                <stop offset="1" stop-color="#1E9FE4" stop-opacity="0" />
                            </linearGradient>
                            <linearGradient id="paint15_linear_18_6002" x1="18.6233" y1="20.3737" x2="19.801"
                                y2="20.3737" gradientUnits="userSpaceOnUse">
                                <stop stop-color="#48E0FF" />
                                <stop offset="1" stop-color="#48E0FF" stop-opacity="0" />
                            </linearGradient>
                            <linearGradient id="paint16_linear_18_6002" x1="19.5102" y1="14.9738" x2="20.2994"
                                y2="17.3415" gradientUnits="userSpaceOnUse">
                                <stop stop-color="#43B3F2" />
                                <stop offset="1" stop-color="#43B3F2" stop-opacity="0" />
                            </linearGradient>
                            <linearGradient id="paint17_linear_18_6002" x1="8.51355" y1="23.4679" x2="16.2566"
                                y2="23.4232" gradientUnits="userSpaceOnUse">
                                <stop stop-color="#70504D" />
                                <stop offset="1" stop-color="#9B665E" />
                            </linearGradient>
                            <linearGradient id="paint18_linear_18_6002" x1="16.1171" y1="2.9408" x2="16.1171"
                                y2="17.9099" gradientUnits="userSpaceOnUse">
                                <stop stop-color="#EA6D2E" />
                                <stop offset="1" stop-color="#CA222B" />
                            </linearGradient>
                            <radialGradient id="paint19_radial_18_6002" cx="0" cy="0" r="1"
                                gradientUnits="userSpaceOnUse"
                                gradientTransform="translate(16.9565 1.93029) rotate(97.3264) scale(3.60529 6.72868)">
                                <stop stop-color="#FF853F" />
                                <stop offset="1" stop-color="#FF853F" stop-opacity="0" />
                            </radialGradient>
                            <linearGradient id="paint20_linear_18_6002" x1="29.3125" y1="29.9317" x2="1.43751"
                                y2="29.9317" gradientUnits="userSpaceOnUse">
                                <stop stop-color="#3FD47B" />
                                <stop offset="1" stop-color="#40DC7F" />
                            </linearGradient>
                            <linearGradient id="paint21_linear_18_6002" x1="16.1171" y1="30.4683" x2="16.1171"
                                y2="28.9206" gradientUnits="userSpaceOnUse">
                                <stop offset="0.107097" stop-color="#3FD17B" />
                                <stop offset="1" stop-color="#3FD17B" stop-opacity="0" />
                            </linearGradient>
                            <radialGradient id="paint22_radial_18_6002" cx="0" cy="0" r="1"
                                gradientUnits="userSpaceOnUse"
                                gradientTransform="translate(30.0858 27.6187) rotate(147.147) scale(3.35178 5.4961)">
                                <stop stop-color="#5CEE92" />
                                <stop offset="1" stop-color="#5CEE92" stop-opacity="0" />
                            </radialGradient>
                            <linearGradient id="paint23_linear_18_6002" x1="7.82284" y1="27.9096" x2="16.856"
                                y2="27.9096" gradientUnits="userSpaceOnUse">
                                <stop stop-color="#9FA1A3" />
                                <stop offset="1" stop-color="#C4C1C7" />
                            </linearGradient>
                            <linearGradient id="paint24_linear_18_6002" x1="7.40106" y1="27.9096" x2="8.55148"
                                y2="27.9096" gradientUnits="userSpaceOnUse">
                                <stop stop-color="#59675C" />
                                <stop offset="1" stop-color="#59675C" stop-opacity="0" />
                            </linearGradient>
                            <linearGradient id="paint25_linear_18_6002" x1="17.2077" y1="27.4686" x2="15.6962"
                                y2="28.4091" gradientUnits="userSpaceOnUse">
                                <stop stop-color="#E3DADD" />
                                <stop offset="1" stop-color="#E3DADD" stop-opacity="0" />
                            </linearGradient>
                            <linearGradient id="paint26_linear_18_6002" x1="15.946" y1="3.70152" x2="29.6497"
                                y2="17.8102" gradientUnits="userSpaceOnUse">
                                <stop stop-color="#FF8337" />
                                <stop offset="1" stop-color="#F24747" />
                            </linearGradient>
                            <linearGradient id="paint27_linear_18_6002" x1="16.731" y1="3.70152" x2="3.02732"
                                y2="17.8102" gradientUnits="userSpaceOnUse">
                                <stop stop-color="#FF8337" />
                                <stop offset="1" stop-color="#F24747" />
                            </linearGradient>
                        </defs>
                    </svg>
                </fluent-button>
                <fluent-button id="folder-btn" appearance="transparent" title="文件夹">
                    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 32 32" fill="none">
                        <g filter="url(#filter0_ii_18_22534)">
                            <path
                                d="M3.82416 4.125C2.85767 4.125 2.07416 4.90851 2.07416 5.875V10.9375C2.07416 10.9941 2.07684 11.05 2.08209 11.1052V25.1875C2.08209 26.154 2.8656 26.9375 3.83209 26.9375H28.1758C29.1423 26.9375 29.9258 26.154 29.9258 25.1875V9.78125C29.9258 8.81476 29.1423 8.03125 28.1758 8.03125H17.3109C16.7965 8.03125 16.3019 7.83305 15.9298 7.47784L12.9976 4.67841C12.6255 4.3232 12.1309 4.125 11.6165 4.125H3.82416Z"
                                fill="url(#paint0_linear_18_22534)" />
                            <path
                                d="M3.82416 4.125C2.85767 4.125 2.07416 4.90851 2.07416 5.875V10.9375C2.07416 10.9941 2.07684 11.05 2.08209 11.1052V25.1875C2.08209 26.154 2.8656 26.9375 3.83209 26.9375H28.1758C29.1423 26.9375 29.9258 26.154 29.9258 25.1875V9.78125C29.9258 8.81476 29.1423 8.03125 28.1758 8.03125H17.3109C16.7965 8.03125 16.3019 7.83305 15.9298 7.47784L12.9976 4.67841C12.6255 4.3232 12.1309 4.125 11.6165 4.125H3.82416Z"
                                fill="url(#paint1_linear_18_22534)" />
                        </g>
                        <g filter="url(#filter1_ii_18_22534)">
                            <rect x="2.07416" y="11.0625" width="27.8438" height="18.9062" rx="1.75"
                                fill="url(#paint2_linear_18_22534)" />
                        </g>
                        <rect x="2.07416" y="11.0625" width="27.8438" height="18.9062" rx="1.75"
                            fill="url(#paint3_linear_18_22534)" />
                        <defs>
                            <filter id="filter0_ii_18_22534" x="1.77416" y="4.125" width="28.2517" height="23.1125"
                                filterUnits="userSpaceOnUse" color-interpolation-filters="sRGB">
                                <feFlood flood-opacity="0" result="BackgroundImageFix" />
                                <feBlend mode="normal" in="SourceGraphic" in2="BackgroundImageFix" result="shape" />
                                <feColorMatrix in="SourceAlpha" type="matrix"
                                    values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 127 0" result="hardAlpha" />
                                <feOffset dx="-0.3" dy="0.3" />
                                <feGaussianBlur stdDeviation="0.375" />
                                <feComposite in2="hardAlpha" operator="arithmetic" k2="-1" k3="1" />
                                <feColorMatrix type="matrix"
                                    values="0 0 0 0 1 0 0 0 0 0.862745 0 0 0 0 0.337255 0 0 0 1 0" />
                                <feBlend mode="normal" in2="shape" result="effect1_innerShadow_18_22534" />
                                <feColorMatrix in="SourceAlpha" type="matrix"
                                    values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 127 0" result="hardAlpha" />
                                <feOffset dx="0.1" dy="0.1" />
                                <feGaussianBlur stdDeviation="0.3" />
                                <feComposite in2="hardAlpha" operator="arithmetic" k2="-1" k3="1" />
                                <feColorMatrix type="matrix"
                                    values="0 0 0 0 0.937255 0 0 0 0 0.67451 0 0 0 0 0.294118 0 0 0 1 0" />
                                <feBlend mode="normal" in2="effect1_innerShadow_18_22534"
                                    result="effect2_innerShadow_18_22534" />
                            </filter>
                            <filter id="filter1_ii_18_22534" x="1.97416" y="10.9625" width="28.0438" height="19.3063"
                                filterUnits="userSpaceOnUse" color-interpolation-filters="sRGB">
                                <feFlood flood-opacity="0" result="BackgroundImageFix" />
                                <feBlend mode="normal" in="SourceGraphic" in2="BackgroundImageFix" result="shape" />
                                <feColorMatrix in="SourceAlpha" type="matrix"
                                    values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 127 0" result="hardAlpha" />
                                <feOffset dx="-0.1" dy="0.3" />
                                <feGaussianBlur stdDeviation="0.375" />
                                <feComposite in2="hardAlpha" operator="arithmetic" k2="-1" k3="1" />
                                <feColorMatrix type="matrix"
                                    values="0 0 0 0 1 0 0 0 0 0.94902 0 0 0 0 0.32549 0 0 0 1 0" />
                                <feBlend mode="normal" in2="shape" result="effect1_innerShadow_18_22534" />
                                <feColorMatrix in="SourceAlpha" type="matrix"
                                    values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 127 0" result="hardAlpha" />
                                <feOffset dx="0.1" dy="-0.1" />
                                <feGaussianBlur stdDeviation="0.15" />
                                <feComposite in2="hardAlpha" operator="arithmetic" k2="-1" k3="1" />
                                <feColorMatrix type="matrix"
                                    values="0 0 0 0 0.941176 0 0 0 0 0.690196 0 0 0 0 0.364706 0 0 0 1 0" />
                                <feBlend mode="normal" in2="effect1_innerShadow_18_22534"
                                    result="effect2_innerShadow_18_22534" />
                            </filter>
                            <linearGradient id="paint0_linear_18_22534" x1="16" y1="4.75" x2="16" y2="11.75"
                                gradientUnits="userSpaceOnUse">
                                <stop stop-color="#FFD152" />
                                <stop offset="1" stop-color="#FFB83D" />
                            </linearGradient>
                            <linearGradient id="paint1_linear_18_22534" x1="16.7475" y1="11.3155" x2="16.7475"
                                y2="10.3434" gradientUnits="userSpaceOnUse">
                                <stop stop-color="#FEB63B" />
                                <stop offset="1" stop-color="#FEB63B" stop-opacity="0" />
                            </linearGradient>
                            <linearGradient id="paint2_linear_18_22534" x1="15.996" y1="11.0625" x2="15.996"
                                y2="29.9688" gradientUnits="userSpaceOnUse">
                                <stop stop-color="#FFE155" />
                                <stop offset="1" stop-color="#FFB45F" />
                            </linearGradient>
                            <linearGradient id="paint3_linear_18_22534" x1="19.882" y1="30.1827" x2="19.882"
                                y2="28.2458" gradientUnits="userSpaceOnUse">
                                <stop stop-color="#F9928A" />
                                <stop offset="1" stop-color="#FFAD5F" stop-opacity="0" />
                            </linearGradient>
                        </defs>
                    </svg>
                </fluent-button>
                <fluent-button id="export-btn" appearance="transparent" title="导出所有图片">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                        <polyline points="7,10 12,15 17,10"/>
                        <line x1="12" y1="15" x2="12" y2="3"/>
                    </svg>
                </fluent-button>
            </nav>

            <!-- 主内容区 -->
            <main>
                <!-- 主页视图 -->
                <div id="home-view" class="view">
                    <fluent-image fit="contain">
                        <img alt="Viewer" src="photo.png" />
                    </fluent-image>
                    <fluent-text size="1200">
                        <h1>微信图片查看器</h1>
                    </fluent-text>
                    <fluent-text>
                        <p>请选择一个根目录以开始浏览图片。</p>
                    </fluent-text>
                    <fluent-button id="select-folder-btn" appearance="accent">
                        选择文件夹
                    </fluent-button>
                    <p id="current-folder-info"></p>
                </div>

                <!-- 文件夹视图 (默认隐藏) -->
                <div id="folder-view" class="view hidden">
                    <!-- 左侧目录树面板 -->
                    <aside class="sidebar">
                        <div class="sidebar-header">目录</div>
                        <div id="dir-tree-container">
                            <fluent-tree id="dir-tree"></fluent-tree>
                        </div>
                    </aside>

                    <!-- 右侧图片展示面板 -->
                    <section class="content-panel">
                        <!-- 面包屑导航 -->
                        <div id="breadcrumb-container">
                            <fluent-breadcrumb id="breadcrumb"></fluent-breadcrumb>
                        </div>
                        <!-- 图片滚动容器 -->
                        <div class="gallery-scroll-container">
                            <!-- JS驱动的瀑布流画廊 -->
                            <div id="image-gallery"></div>
                        </div>
                    </section>
                </div>
            </main>
        </div>
    </fluent-design-system-provider>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- 元素获取 ---
            const homeBtn = document.getElementById('home-btn');
            const folderBtn = document.getElementById('folder-btn');
            const selectFolderBtn = document.getElementById('select-folder-btn');
            const exportBtn = document.getElementById('export-btn');
            const homeView = document.getElementById('home-view');
            const folderView = document.getElementById('folder-view');
            const dirTree = document.getElementById('dir-tree');
            const breadcrumb = document.getElementById('breadcrumb');
            const imageGallery = document.getElementById('image-gallery');
            const scrollContainer = document.querySelector('.gallery-scroll-container');
            const currentFolderInfo = document.getElementById('current-folder-info');

            // Initialize export button as disabled
            if (exportBtn) {
                exportBtn.disabled = true;
                exportBtn.appearance = 'stealth';
            }

            // modal elements
            const modal = document.getElementById('image-modal');
            const modalTitle = document.getElementById('modal-title');
            const modalPrev = document.getElementById('modal-prev');
            const modalNext = document.getElementById('modal-next');
            const modalZoomIn = document.getElementById('modal-zoom-in');
            const modalZoomOut = document.getElementById('modal-zoom-out');
            const modalClose = document.getElementById('modal-close');
            const modalCanvas = document.getElementById('modal-canvas');

            // --- 状态管理 ---
            let currentRootDir = null;
            let currentSelectedFolder = null; // Track the currently selected folder in the tree
            let allImagePaths = [];
            let currentImageIndex = 0;
            let columnElements = [];
            let sentinelObserver = null;
            let isLoading = false; // 关键的加载锁
            let modalOpen = false;
            let modalImage = null;
            let modalCurrentScale = 1;
            const BATCH_SIZE = 10; // 每次滚动加载的图片数量

            // --- 辅助函数：防抖 ---
            function debounce(func, delay) {
                let timeout;
                return function (...args) {
                    clearTimeout(timeout);
                    timeout = setTimeout(() => func.apply(this, args), delay);
                };
            }

            // --- 视图切换 ---
            function switchView(viewName) {
                const isFolderView = viewName === 'folder';
                homeBtn.appearance = isFolderView ? 'stealth' : 'accent';
                folderBtn.appearance = isFolderView ? 'accent' : 'stealth';
                homeView.classList.toggle('hidden', isFolderView);
                folderView.classList.toggle('hidden', !isFolderView);
            }

            // --- 事件监听 ---
            homeBtn.addEventListener('click', () => {
                switchView('home');
                // Disable export button when switching to home view
                if (exportBtn) {
                    exportBtn.disabled = true;
                    exportBtn.appearance = 'stealth';
                }
            });
            folderBtn.addEventListener('click', () => {
                if (currentRootDir) switchView('folder');
                else alert("请先在主页选择一个根目录！");
            });
            selectFolderBtn.addEventListener('click', async () => {
                const result = await window.pywebview.api.open_folder_dialog();
                if (result && result.success) {
                    currentRootDir = result.path;
                    currentFolderInfo.textContent = `当前目录: ${currentRootDir}`;
                    await loadAndRenderDirectoryTree();
                    switchView('folder');
                }
            });

            if (exportBtn) {
                exportBtn.addEventListener('click', async () => {
                    if (!currentRootDir) {
                        alert('请先选择根目录。');
                        return;
                    }

                    // Check if a folder is selected
                    if (!currentSelectedFolder) {
                        alert('请先在左侧选择一个文件夹。');
                        return;
                    }

                    // Check if selected folder is under root directory
                    if (!currentSelectedFolder.startsWith(currentRootDir)) {
                        alert(`选择的文件夹不在根目录下！\n\n根目录: ${currentRootDir}\n选择的文件夹: ${currentSelectedFolder}\n\n请重新选择根目录，确保它包含您要导出的文件夹。`);
                        return;
                    }

                    // Get images from the selected folder
                    const allImages = await window.pywebview.api.get_images_in_folder(currentSelectedFolder);
                    if (!allImages || allImages.length === 0) {
                        alert('选中的文件夹中没有找到可导出的图片文件。');
                        return;
                    }

                    // Prompt for export directory (destination only)
                    const exportDir = await window.pywebview.api.open_export_dialog();
                    if (!exportDir || !exportDir.success) {
                        return; // User cancelled
                    }

                    // Show progress
                    const progressText = `正在导出 ${allImages.length} 个图片到 ${exportDir.path}...`;
                    alert(progressText); // Simple progress indicator

                    try {
                        const result = await window.pywebview.api.export_all_images(exportDir.path, allImages);
                        if (result.success) {
                            alert(result.message);
                        } else {
                            alert(`导出失败: ${result.error}`);
                        }
                    } catch (error) {
                        console.error('Export error:', error);
                        alert('导出过程中发生错误，请查看控制台日志。');
                    }
                });
            }

            window.addEventListener('resize', debounce(() => {
                if (allImagePaths.length > 0 && folderView.classList.contains('hidden') === false) {
                    rebuildLayout();
                }
                if (modalOpen && modalImage) fitImageToViewport(modalImage);
            }, 250));

            // --- 目录树逻辑 (无大改) ---
            async function loadAndRenderDirectoryTree() {
                const treeData = await window.pywebview.api.get_folder_tree();
                if (treeData) {
                    dirTree.innerHTML = '';
                    const treeItem = createTreeNode(treeData);
                    dirTree.appendChild(treeItem);
                    treeItem.expanded = true;
                    treeItem.selected = true;
                    expandAllTree(dirTree);
                    selectTreeNode(treeItem);
                }
            }
            function createTreeNode(nodeData) {
                const treeItem = document.createElement('fluent-tree-item');
                treeItem.dataset.path = nodeData.path;
                treeItem.dataset.name = nodeData.name;
                treeItem.textContent = nodeData.name;
                if (nodeData.children && nodeData.children.length > 0) {
                    nodeData.children.forEach(child => treeItem.appendChild(createTreeNode(child)));
                } else {
                    const icon = document.createElement('span');
                    icon.slot = 'start';
                    treeItem.appendChild(icon);
                }
                return treeItem;
            }
            // Expand all tree items under a root element
            function expandAllTree(rootEl) {
                if (!rootEl) return;
                const items = rootEl.querySelectorAll('fluent-tree-item');
                items.forEach(it => it.expanded = true);
            }
            dirTree.addEventListener('click', e => {
                const clickedItem = e.target.closest('fluent-tree-item');
                if (clickedItem) selectTreeNode(clickedItem);
            });
            function selectTreeNode(nodeElement) {
                if (!nodeElement) return;
                let parent = nodeElement.parentElement;
                while (parent && parent.tagName === 'FLUENT-TREE-ITEM') {
                    parent.expanded = true;
                    parent = parent.parentElement;
                }
                dirTree.querySelectorAll('fluent-tree-item').forEach(item => item.selected = false);
                nodeElement.selected = true;
                const folderPath = nodeElement.dataset.path;
                if (folderPath) {
                    currentSelectedFolder = folderPath; // Track selected folder
                    // Enable export button when a folder is selected
                    if (exportBtn) {
                        exportBtn.disabled = false;
                        exportBtn.appearance = 'transparent';
                    }
                    updateBreadcrumb(folderPath);
                    startImageLoading(folderPath);
                }
            }
            function updateBreadcrumb(path) {
                breadcrumb.innerHTML = '';
                if (!currentRootDir || !path.startsWith(currentRootDir)) {
                    const item = document.createElement('fluent-breadcrumb-item');
                    item.textContent = path;
                    breadcrumb.appendChild(item);
                    return;
                }
                let runningPath = currentRootDir;
                const rootName = currentRootDir.split(/[\\/]/).pop();
                const rootItem = document.createElement('fluent-breadcrumb-item');
                rootItem.textContent = rootName;
                rootItem.dataset.path = runningPath;
                breadcrumb.appendChild(rootItem);
                const relativePath = path.substring(currentRootDir.length);
                const parts = relativePath.split(/[\\/]/).filter(p => p);
                const separatorChar = path.includes('\\') ? '\\' : '/';
                parts.forEach(part => {
                    runningPath += separatorChar + part;
                    const item = document.createElement('fluent-breadcrumb-item');
                    item.textContent = part;
                    item.dataset.path = runningPath;
                    breadcrumb.appendChild(item);
                });
            }
            breadcrumb.addEventListener('click', e => {
                const targetItem = e.target.closest('fluent-breadcrumb-item');
                if (targetItem && targetItem.dataset.path) {
                    const path = targetItem.dataset.path.replace(/\\/g, '\\\\');
                    const nodeElement = dirTree.querySelector(`fluent-tree-item[data-path="${path}"]`);
                    if (nodeElement) selectTreeNode(nodeElement);
                }
            });


            // --- 全新图片加载和布局逻辑 ---

            // 1. 启动或重置图片加载流程
            async function startImageLoading(folderPath) {
                if (isLoading) return;
                isLoading = true;

                // 清理
                if (sentinelObserver) sentinelObserver.disconnect();
                imageGallery.innerHTML = '';
                currentImageIndex = 0;
                columnElements = [];
                scrollContainer.scrollTop = 0; // 回到顶部

                try {
                    allImagePaths = await window.pywebview.api.get_images_in_folder(folderPath);
                    if (!allImagePaths || allImagePaths.length === 0) {
                        imageGallery.innerHTML = '<fluent-p>该目录下没有找到可显示的图片文件。</fluent-p>';
                        return;
                    }
                    setupLayout();
                    loadInitialImages();
                } catch (e) {
                    console.error(`startImageLoading: 获取图片列表失败:`, e);
                } finally {
                    isLoading = false;
                }
            }

            // 1a. 当窗口大小改变时，重建布局
            function rebuildLayout() {
                const images = Array.from(imageGallery.querySelectorAll('.image-card'));
                setupLayout(); // 创建新列
                // 将已存在的图片卡片重新分配到新列中
                images.forEach(card => {
                    const shortestColumn = getShortestColumn();
                    shortestColumn.appendChild(card);
                });
            }

            // 2. 设置布局（创建列和观察器）
            function setupLayout() {
                imageGallery.innerHTML = '';
                const galleryWidth = imageGallery.clientWidth - 32; // 减去左右padding的16px*2
                const targetColWidth = 200; // 目标列宽
                const gapWidth = 16; // 列间距

                // 计算列数：总宽度除以（目标宽度+间距）
                const numCols = Math.max(1, Math.floor((galleryWidth + gapWidth) / (targetColWidth + gapWidth)));

                // 计算实际列宽：(总宽度 + 间距) / 列数 - 间距
                const actualColWidth = (galleryWidth + gapWidth) / numCols - gapWidth;

                columnElements = [];
                for (let i = 0; i < numCols; i++) {
                    const col = document.createElement('div');
                    col.className = 'image-column';
                    col.style.width = actualColWidth + 'px';
                    columnElements.push(col);
                    imageGallery.appendChild(col);
                }

                // 创建哨兵观察器
                sentinelObserver = new IntersectionObserver(entries => {
                    if (entries[0].isIntersecting && !isLoading) {
                        loadMoreImages();
                    }
                }, { root: scrollContainer, rootMargin: "500px" });
            }

            // 3. 初始加载，填满视区
            function loadInitialImages() {
                // 持续加载，直到最短的列超出视区底部
                while (currentImageIndex < allImagePaths.length) {
                    const shortestColumn = getShortestColumn();
                    if (shortestColumn.offsetHeight > scrollContainer.clientHeight) {
                        break; // 视区已满
                    }
                    addImageToColumn(shortestColumn);
                }
                setupSentinel(); // 设置哨兵以备滚动
            }

            // 4. 加载更多图片（由哨兵触发）
            function loadMoreImages() {
                if (isLoading) return;
                isLoading = true;

                const fragment = document.createDocumentFragment();
                const limit = Math.min(currentImageIndex + BATCH_SIZE, allImagePaths.length);

                for (let i = currentImageIndex; i < limit; i++) {
                    addImageToColumn(getShortestColumn());
                }

                setupSentinel();
                isLoading = false;
            }

            // 5. 添加单张图片到指定列
            function addImageToColumn(column) {
                if (currentImageIndex >= allImagePaths.length) return;

                const relPath = allImagePaths[currentImageIndex];
                currentImageIndex++;

                const card = document.createElement('fluent-card');
                card.className = 'image-card is-loading';
                const img = document.createElement('img');
                img.dataset.relPath = relPath;
                const caption = document.createElement('div');
                caption.className = 'caption';
                caption.textContent = relPath.split(/[\\/]/).pop();

                const placeholder = document.createElement('div');
                placeholder.className = 'image-placeholder';
                placeholder.innerHTML = '<fluent-progress-ring></fluent-progress-ring>';

                card.appendChild(placeholder);
                card.appendChild(img);
                card.appendChild(caption);
                column.appendChild(card);

                fetchAndSetImage(relPath, img);

                // show zoom cursor
                img.style.cursor = 'zoom-in';
            }

            // 6. 放置哨兵
            function setupSentinel() {
                let sentinel = document.getElementById('sentinel');
                if (sentinel) sentinelObserver.unobserve(sentinel);

                if (currentImageIndex < allImagePaths.length) {
                    if (!sentinel) {
                        sentinel = document.createElement('div');
                        sentinel.id = 'sentinel';
                    }
                    // 将哨兵放在最短列的末尾，确保它能被正确触发
                    getShortestColumn().appendChild(sentinel);
                    sentinelObserver.observe(sentinel);
                } else if (sentinel) {
                    sentinel.remove();
                }
            }

            // 7. 辅助函数：获取当前最短的列
            function getShortestColumn() {
                return columnElements.reduce((shortest, current) =>
                    current.offsetHeight < shortest.offsetHeight ? current : shortest, columnElements[0]);
            }

            // 8. 获取并设置图片数据（与之前相同）
            async function fetchAndSetImage(relPath, imgElement) {
                try {
                    const base64 = await window.pywebview.api.decrypt_dat(relPath);
                    if (!base64) throw new Error("解密返回空数据。");
                    const bytes = Uint8Array.from(atob(base64), c => c.charCodeAt(0));
                    const imageBlob = new Blob([bytes], { type: "image/jpeg" });
                    const objectURL = URL.createObjectURL(imageBlob);

                    imgElement.src = objectURL;
                    imgElement.onload = () => {
                        imgElement.closest('.image-card')?.classList.remove('is-loading');
                        URL.revokeObjectURL(objectURL);
                    };
                    imgElement.onerror = () => { throw new Error("无法从Blob加载图片。"); }
                } catch (error) {
                    console.error(`fetchAndSetImage: 无法加载图片 ${relPath}:`, error);
                    const card = imgElement.closest('.image-card');
                    if (card) {
                        const placeholder = card.querySelector('.image-placeholder');
                        if (placeholder) placeholder.innerHTML = '加载失败';
                    }
                }
            }

            // --- Modal functionality ---
            function showModal() {
                console.log('showModal called, modal element:', modal);
                modal.style.display = 'flex';
                modal.setAttribute('aria-hidden', 'false');
                modalOpen = true;
                console.log('modalOpen set to:', modalOpen);
            }

            function hideModal() {
                modal.style.display = 'none';
                modal.setAttribute('aria-hidden', 'true');
                modalOpen = false;
                try { window.pywebview.api.update_window_title('微信图片查看器'); } catch (e) {}
                document.title = '微信图片查看器';
            }

            async function openImagePopup(index) {
                console.log('openImagePopup called with index:', index);
                if (!allImagePaths || index < 0 || index >= allImagePaths.length) return;
                currentImageIndex = index;
                const relPath = allImagePaths[index];
                const filename = relPath.split(/[\\\/]/).pop();
                console.log('Opening image:', filename, 'relPath:', relPath);
                modalTitle.textContent = filename;
                try { await window.pywebview.api.update_window_title(filename + ' - 微信图片查看器'); } catch (e) {}
                document.title = filename + ' - 微信图片查看器';
                try {
                    console.log('Calling decrypt_dat...');
                    const base64 = await window.pywebview.api.decrypt_dat(relPath);
                    console.log('decrypt_dat returned, base64 length:', base64 ? base64.length : 0);
                    if (!base64) throw new Error('解密返回空数据');
                    const bytes = Uint8Array.from(atob(base64), c => c.charCodeAt(0));
                    const blob = new Blob([bytes], { type: 'image/jpeg' });
                    const url = URL.createObjectURL(blob);
                    console.log('Created blob URL:', url);
                    const img = new Image();
                    img.onload = () => { 
                        console.log('Image loaded successfully, dimensions:', img.naturalWidth, 'x', img.naturalHeight);
                        modalImage = img; 
                        modalCurrentScale = 1; 
                        fitImageToViewport(img); 
                        URL.revokeObjectURL(url); 
                    };
                    img.onerror = (e) => console.error('modal image load error', e);
                    img.src = url;
                    console.log('Calling showModal...');
                    showModal();
                } catch (e) { console.error('openImagePopup error', e); alert('无法打开图片: ' + e); }
            }

            function fitImageToViewport(img) {
                const maxViewportWidth = window.innerWidth - 120;
                const maxViewportHeight = window.innerHeight - 120;
                const scaleW = maxViewportWidth / img.naturalWidth;
                const scaleH = maxViewportHeight / img.naturalHeight;
                modalCurrentScale = Math.min(1, Math.max(0.1, Math.min(scaleW, scaleH)));
                renderImageToCanvas(img, modalCurrentScale);
            }

            function renderImageToCanvas(img, scale) {
                const ctx = modalCanvas.getContext('2d');
                const maxViewportWidth = window.innerWidth - 120;
                const maxViewportHeight = window.innerHeight - 120;
                let displayW, displayH;
                if (scale === 1) {
                    displayW = Math.min(img.naturalWidth, maxViewportWidth);
                    displayH = Math.min(img.naturalHeight, maxViewportHeight);
                    const rW = displayW / img.naturalWidth;
                    const rH = displayH / img.naturalHeight;
                    const r = Math.min(rW, rH);
                    displayW = Math.round(img.naturalWidth * r);
                    displayH = Math.round(img.naturalHeight * r);
                } else {
                    displayW = Math.round(img.naturalWidth * scale);
                    displayH = Math.round(img.naturalHeight * scale);
                    const rW = maxViewportWidth / displayW;
                    const rH = maxViewportHeight / displayH;
                    const r = Math.min(1, Math.min(rW, rH));
                    displayW = Math.round(displayW * r);
                    displayH = Math.round(displayH * r);
                }
                modalCanvas.width = displayW;
                modalCanvas.height = displayH;
                modalCanvas.style.width = displayW + 'px';
                modalCanvas.style.height = displayH + 'px';
                ctx.clearRect(0, 0, modalCanvas.width, modalCanvas.height);
                ctx.imageSmoothingEnabled = true;
                ctx.drawImage(img, 0, 0, img.naturalWidth, img.naturalHeight, 0, 0, modalCanvas.width, modalCanvas.height);
            }

            modalPrev.addEventListener('click', () => { if (!allImagePaths || allImagePaths.length === 0) return; let idx = currentImageIndex - 1; if (idx < 0) idx = allImagePaths.length - 1; openImagePopup(idx); });
            modalNext.addEventListener('click', () => { if (!allImagePaths || allImagePaths.length === 0) return; let idx = currentImageIndex + 1; if (idx >= allImagePaths.length) idx = 0; openImagePopup(idx); });
            modalClose.addEventListener('click', hideModal);
            modalZoomIn.addEventListener('click', () => { if (!modalImage) return; modalCurrentScale = Math.min(5, modalCurrentScale * 1.2); renderImageToCanvas(modalImage, modalCurrentScale); });
            modalZoomOut.addEventListener('click', () => { if (!modalImage) return; modalCurrentScale = Math.max(0.1, modalCurrentScale / 1.2); renderImageToCanvas(modalImage, modalCurrentScale); });

            document.addEventListener('keydown', (e) => {
                if (!modalOpen) return;
                if (e.key === 'Escape') hideModal();
                if (e.key === 'ArrowLeft') modalPrev.click();
                if (e.key === 'ArrowRight') modalNext.click();
            });

            // delegated click handler for thumbnails
            imageGallery.addEventListener('click', (e) => {
                console.log('Gallery clicked, target:', e.target);
                const img = e.target.closest && e.target.closest('img');
                console.log('Found img element:', img);
                if (!img) return;
                const rel = img.dataset.relPath;
                console.log('Image relPath:', rel);
                if (rel) {
                    console.debug('thumbnail clicked', rel);
                    const idx = allImagePaths.indexOf(rel);
                    console.log('Image index:', idx, 'Total images:', allImagePaths ? allImagePaths.length : 0);
                    if (idx >= 0) {
                        console.log('Opening image popup for index:', idx);
                        openImagePopup(idx);
                    }
                }
            });

            // --- 初始化 ---
            switchView('home');
        });
    </script>

    <!-- Modal for full-size image viewing -->
    <div id="image-modal" role="dialog" aria-modal="true">
        <div class="modal-toolbar">
            <button id="modal-prev">上一张</button>
            <button id="modal-next">下一张</button>
            <span style="width:10px"></span>
            <button id="modal-zoom-in">放大</button>
            <button id="modal-zoom-out">缩小</button>
        </div>
        <button id="modal-close" class="close-btn" aria-label="关闭">关闭</button>
        <div class="modal-content">
            <canvas id="modal-canvas" style="background:#000; display:block;"></canvas>
            <div id="modal-title" class="modal-caption"></div>
        </div>
    </div>
</body>

</html>